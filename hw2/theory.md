# به نام خداوند بخشنده‌ی مهربان
## پاسخ سوال نظری تمرین دوم درس شبکه‌های کامپیوتری - دکتر جعفری
### محمدمهدی فاریابی - ۹۳۱۰۱۹۵۱

---

---
برقراری ارتباط TCP شامل سه فاز ارسال بسته‌ SYN از فرستنده به گیرنده، ارسال بسته‌ SYN_ACK از گیرنده به فرستنده و ارسال بسته‌ ACK از فرستنده به گیرنده است. با تبادل موفقیت آمیز این سه بسته‌ عملیات ارسال پکت‌های دارای payload از فرستنده به گیرنده شروع شده و داده‌ی مورد نظر منتقل می‌شود. در نهایت فرستنده با ارسال بسته‌ FIN قصد خود مبنی بر اتمام عملیات را به گیرنده اعلام می‌کند و بعد از آن داده‌ای ارسال نمی‌کند. در صورتی که گیرنده این بسته‌ را به درستی دریافت کند، بسته‌ ACK آن را به فرستنده ارسال می‌کند. داده‌های باقیمانده‌ی خود را ارسال کرده و بسته‌ FIN برای فرستنده می‌فرستد. فرستنده نیز با دریافت این بسته‌ ACK آن را برای گیرنده ارسال کرده و ارتباط به کلی قطع می‌شود.

حالات مختلف خطا (غیر از حالت عادی که توصیف شد) را برای هر یک از این پکت‌های handshake بررسی می‌کنیم:

---

## بسته‌ SYN:
 
**گم شدن:** ممکن است این بسته‌ هیچگاه به مقصد نرسد. در این صورت فرستنده بعد از مدتی که بسته‌ SYN_ACK را دریافت نکند، timeout شده و مجددا بسته‌ SYN را ارسال می‌کند.

**دیر رسیدن:** ممکن است این بسته‌ دیر به مقصد برسد به این ترتیب که فرستنده که بسته‌ SYN_ACK را دریافت نکرده مجددا بسته‌ SYN را ارسال کند ولی هر دو بسته‌ SYN به گیرنده برسند. در این صورت گیرنده با دریافت اولین بسته‌ SYN، بسته‌ SYN_ACK را برای فرستنده ارسال می‌کند و پکت‌های SYN بعدی را در نظر نگرفته و discard می‌کند.

**اشتباه رسیدن:** ممکن است این بسته‌ به درستی منتقل نشده باشد. به این صورت که اطلاعات آن دستخوش تغییر شده باشند. در این صورت اگر اشتباه توسط checksum تشخیص داده شود، بسته‌ discard می‌شود و به این ترتیب فرستنده timeout شده و مجددا بسته‌ را ارسال می‌کند و اگر checksum نتواند اشتباه بودن این بسته‌ را تشخیص دهد و بسته‌ هم یک بسته‌ SYN معتبر (مثلا شماره‌ی پورت فرستنده اشتباه باشد) باشد، گیرنده وارد فاز برقراری ارتباط با فرستنده‌ای که وجود ندارد می‌شود اما بعد از مدتی با دریافت نکردن ACK از آن timeout شده و به حالت listening for connection بر می‌گردد. گیرنده هم با دریافت نکردن SYN_ACK به موقع از فرستنده timeout شده و مجددا بسته‌ SYN را ارسال می‌کند.

---

## بسته‌ SYN_ACK: 

**گم شدن:** در صورتی که بسته‌ SYN_ACK گم شود و به فرستنده نرسد، بعد از مدتی هر دوی فرستنده و گیرنده timeout  می‌شوند. زیرا فرستنده منتظر SYN_ACK و گیرنده منتظر ACK است. در این صورت فرستنده مجددا بسته‌ SYN را ارسال می‌کند و گیرنده هم با دریافت نکردن ACK از فرستنده timeout شده و به حالت listening for connection بر می‌گردد.

**دیر رسیدن:** ممکن است بسته‌ SYN_ACK دیر به فرستنده برسد و فرستنده به حالت فرستادن SYN رفته باشد. در این صورت فرستنده مجددا بسته‌ SYN را ارسال می‌کند (احتمالا با شماره‌ی توالی دیگری) و وقتی بسته‌ SYN_ACK دیر رسیده را دریافت کرد متوجه اشتباه بودن شماره‌ی توالی آن شده و بسته‌ را ignore می‌کند. در این صورت گیرنده در حالتی ست که منتظر بسته‌ ACK است و با دریافت بسته‌ SYN به حالت ارسال SYN_ACK برای بسته‌ SYN جدید می‌رود.

**اشتباه رسیدن:** ممکن است بسته‌ SYN_ACK حین ارسال از گیرنده به فرستنده تغییر کند در این صورت فرستنده متوجه این تغییر می‌شود (تغییرات ممکن محدود به تغییر آدرس IP یا شماره‌ی پورت فرستنده یا گیرنده، اشتباه بودن checksum، تغییر در مقدار فیلدهای کنترلی و پرچم‌هاست که همگی با توجه به پکت‌های قبلی قابل تشخیص است). در این صورت فرستنده مجددا بسته‌ SYN را برای گیرنده ارسال می‌کند و گیرنده برای بسته‌ SYN جدید بسته‌ SYN_ACK می‌فرستد.

---

## بسته‌ ACK: 

**گم شدن:** ممکن است بسته‌ ACK ارسالی از فرستنده به گیرنده حین ارسال گم شود. در این صورت دو سناریو متصور است (البته پشتیبانی از این رفتارها بستگی به پیاده سازی دارد):
1.	یکی آنکه اولین بسته‌ داده به موقع و پیش از timeout شدن گیرنده به آن برسد. در این صورت آن بسته‌ با ACK تجمعی خود، بسته‌ ACK گم شده را نیز تایید کرده و گیرنده وارد فاز دریافت داده می‌شود.
2.	گیرنده timeout می‌شود و به حالت listening for connection برگشته و پس از آن برای پکت‌های داده‌ی فرستنده ACK ای ارسال نمی‌کند. در این صورت فرستنده بعد از مدتی متوجه عدم حضور گیرنده شده و ارتباط قطع می‌شود.


**دیر رسیدن:** ممکن است بسته‌ ACK دیر به گیرنده برسد و قبل از آن گیرنده timeout  شده باشد. در این صورت گیرنده بسته‌ ACK را در نظر نگرفته و discard می‌کند. در صورتی که بسته‌ ACK دیر به گیرنده برسد ولی گیرنده با دریافت اولین بسته‌ داده به دریافت داده مشغول باشد، بسته‌ دیر رسیده‌ی ACK را که شماره‌ی ACK آن از شماره‌ی ACK کوچکترین بسته‌ پنجره‌ی دریافت کمتر است در نظر نگرفته و discard می‌کند و به دریافت اطلاعات ادامه می‌دهد.

**اشتباه رسیدن:** ممکن است بسته‌ طی مسیر دچار تغییراتی شده باشد. در این صورت یا این تغییرات برای گیرنده قابل تشخیص است (مثلا با استفاده از checksum) که در این صورت بسته‌ discard می‌شود. یا اینکه این بسته‌ به شمایل یک بسته‌ معتبر ACK در آمده که در صورتی که شماره‌ی ACK آن قدیمی باشد یا از شماره‌ی  پکت‌های موجود در پنجره‌ی ارسال فرستنده بیشتر باشد، توسط گیرنده discard می‌شود. در غیر این صورت این بسته‌ می‌تواند در فرایند ارسال اطلاعات خلل ایجاد کند و داده‌ای را که گیرنده دریافت نکرده برای فرستنده ACK کند. در این صورت گیرنده با ارسال ACK های متوالی درخواست داده‌ی دریافت نشده را می‌کند و در صورتی که فرستنده آن داده را در پنجره‌ی ارسال نداشته باشد، ارتباط بعد از مدتی دچار شدن به deadlock و بدون تبادل داده قطع می‌شود. 

---

## بسته‌ FIN فرستنده: 

**گم شدن:** در صورتی که بسته‌ FIN در مسیر ارسال گم شود و به گیرنده نرسد باعث timeout شدن فرستنده خواهد شد. در این صورت فرستنده مجددا بسته‌ FIN را ارسال خواهد کرد.

**دیر رسیدن:** در صورتی که بسته‌ FIN دیر به گیرنده برسد و فرستنده با دریافت نکردن ACK آن timeout شود، مجددا بسته‌ FIN را ارسال می‌کند گیرنده با دریافت FIN مجددا ACK آن را برای فرستنده ارسال می‌کند.

**اشتباه رسیدن:** در صورتی که بسته‌ FIN فرستنده حین ارسال تغییر کند، این اشتباه توسط گیرنده قابل تشخیص است (گیرنده در این لحظه منتظر دریافت یک بسته‌ دارای payload یا FIN است) در این صورت بسته‌ discard شده و باعث می‌شود فرستنده timeout شده و سناریویی مشابه گم شدن رخ دهد.

---

## بسته‌ FIN_ACK گیرنده: 

**گم شدن:** در صورتی که بسته‌ FIN_ACK گیرنده گم شود باعث timeout شدن فرستنده شده و فرستنده مجددا بسته‌ FIN ارسال می‌کند. در این صورت گیرنده مجددا بسته‌ FIN_ACK را ارسال می‌کند.

**دیر رسیدن:** در صورتی که بسته‌ FIN_ACK دیر به فرستنده برسد باعث ارسال مجدد FIN از فرستنده خواهد شد. در این صورت گیرنده به ازای هر FIN دریافت شده یک بسته‌ FIN_ACK ارسال می‌کند.

**اشتباه رسیدن:** در صورتی که بسته‌ FIN_ACK اشتباه برسد، این اشتباه تشخیص داده شده (به علت آنکه فرستنده منتظر یک بسته‌ خاص است!) و توسط فرستنده discard  می‌شود. فرستنده در این صورت مجددا بسته‌ FIN را ارسال می‌کند.

---

## بسته‌ FIN گیرنده: 

**گم شدن:** در صورتی که بسته‌ FIN در مسیر ارسال گم شود و به فرستنده نرسد باعث timeout شدن گیرنده خواهد شد. در این صورت گیرنده مجددا بسته‌ FIN را ارسال خواهد کرد.

**دیر رسیدن:** در صورتی که بسته‌ FIN دیر به فرستنده برسد و گیرنده با دریافت نکردن ACK آن timeout شود، مجددا بسته‌ FIN را ارسال می‌کند فرستنده با دریافت اولین FIN ، ACK آن را برای گیرنده ارسال می‌کند. و اتصال را می‌بندد. FIN های بعدی ارسالی همگی timeout می‌شوند و از این رو گیرنده متوجه می‌شود فرستنده ارتباط را ترک کرده و ارتباط را قطع می‌کند.

**اشتباه رسیدن:** در صورتی که بسته‌ FIN گیرنده حین ارسال تغییر کند، این اشتباه توسط فرستنده قابل تشخیص است (فرستنده در این لحظه منتظر دریافت یک بسته‌ FIN است) در این صورت بسته‌ discard شده و باعث می‌شود گیرنده timeout شده و سناریویی مشابه گم شدن رخ دهد.

---

## بسته‌ FIN_ACK فرستنده:

**گم شدن:** در صورتی که بسته‌ FIN_ACK فرستنده گم شود باعث timeout شدن گیرنده شده و فرستنده مجددا بسته‌ FIN ارسال می‌کند. در این صورت فرستنده ارتباط را بسته و دیگر پاسخگو نیست بنابر این تمامی پکت‌های FIN گیرنده timeout می‌شوند و گیرنده از این طریق متوجه بسته شدن ارتباط شده و ارتباط را قطع می‌کند.

**دیر رسیدن:** در صورتی که بسته‌ FIN_ACK دیر به گیرنده برسد باعث ارسال مجدد FIN از گیرنده خواهد شد. در این صورت فرستنده ارتباط را بسته و دیگر پاسخگو نیست بنابر این تمامی پکت‌های FIN گیرنده timeout می‌شوند و گیرنده از این طریق متوجه بسته شدن ارتباط شده و ارتباط را قطع می‌کند.

**اشتباه رسیدن:** در صورتی که بسته‌ FIN_ACK اشتباه برسد، این اشتباه توسط گیرنده تشخیص داده شده (به علت آنکه گیرنده منتظر یک بسته‌ خاص است!) و توسط گیرنده discard  می‌شود. گیرنده در این صورت مجددا بسته‌ FIN را ارسال می‌کند. اما فرستنده ارتباط را بسته و دیگر پاسخگو نیست بنابر این تمامی پکت‌های FIN گیرنده timeout می‌شوند و گیرنده از این طریق متوجه بسته شدن ارتباط شده و ارتباط را قطع می‌کند.

---

لازم به توجه است که پکت‌هایی از نوع  RST هم در پیاده سازی واقعی TCP داریم که در مواقعی به کار می روند که یک سرور بخواهد reset شدن خود را به client ش خبر دهد تا client از اینکه پس از مدتی سرور پاسخگو نیست متوجه عدم حضور آن نشود و سریعتر خود را ریست کند. از آنجایی که در صورت تمرین به غیر از شکل از این نوع بسته‌ نامی برده نشده به ذکر توضیحات در همین سطح بسنده می‌کنیم.

---

همچنین لازم به توجه است که حالت دیگری نیز برای یک host علاوه بر حالات server و client وجود دارد که حالتی است که در آن host می‌تواند هر یک از client یا server باشد و بسته به نوع بسته‌ای که دریافت می‌کند رفتارش را تعیین کند.

---